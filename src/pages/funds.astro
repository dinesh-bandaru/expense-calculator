---
import Layout from "../layouts/Layout.astro";
import GlobalControls from "../components/GlobalControls.astro";
import PageHeader from "../components/PageHeader.astro";
import ChartCard from "../components/ChartCard.astro";
---

<Layout>
    <section class="app">
        <PageHeader eyebrow="Real World Data" title="Analyze Actual Funds">
            <a href="/" slot="back-link" class="back-link"
                >‚Üê Back to Simulator</a
            >
            Select a mutual fund to see how its historical 5-year CAGR and expense
            ratio would impact your returns over time.
            <GlobalControls slot="controls" />
        </PageHeader>

        <section class="controls">
            <div class="control">
                <div class="control__label">
                    <label for="categorySelect">Fund Category</label>
                </div>
                <select id="categorySelect" class="select-input">
                    <option value="indian_mutual_funds"
                        >Indian Mutual Funds</option
                    >
                    <option value="american_mutual_funds_and_etfs"
                        >American Funds & ETFs</option
                    >
                </select>
            </div>

            <div class="control">
                <div class="control__label">
                    <label for="fundSelect">Select Fund</label>
                </div>
                <select id="fundSelect" class="select-input">
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="control">
                <div class="control__label">
                    <span>Projection length</span>
                    <span id="yearsDisplay">20 years</span>
                </div>
                <input
                    id="yearSlider"
                    type="range"
                    min="5"
                    max="40"
                    step="1"
                    value="20"
                />
            </div>

            <div class="control stats-display">
                <div class="stat-item">
                    <span class="stat-label">5Y CAGR</span>
                    <span class="stat-value" id="cagrDisplay">--%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Expense Ratio</span>
                    <span class="stat-value" id="expenseDisplay">--%</span>
                </div>
            </div>
        </section>

        <ChartCard title="Fund Name" chartId="fundChart" />
    </section>
</Layout>

<script>
    import { Chart, registerables } from "chart.js";
    import { computeCompoundInterest } from "../lib/finance";
    import mutualFundsData from "../data/mutualFunds.json";
    import { getState, setState, subscribe, formatMoney } from "../lib/store";

    Chart.register(...registerables);

    const categorySelect = document.getElementById(
        "categorySelect",
    ) as HTMLSelectElement;
    const fundSelect = document.getElementById(
        "fundSelect",
    ) as HTMLSelectElement;
    const yearSlider = document.getElementById(
        "yearSlider",
    ) as HTMLInputElement;
    const yearsDisplay = document.getElementById("yearsDisplay");
    const cagrDisplay = document.getElementById("cagrDisplay");
    const expenseDisplay = document.getElementById("expenseDisplay");
    const fundNameTitle = document.getElementById("chartTitle");
    const netLossEl = document.getElementById("netLossValue");
    const lossLabel = document.getElementById("lossLabel");
    const ctx = document.getElementById("fundChart") as HTMLCanvasElement;
    const principalDisplay = document.getElementById("principalDisplay");

    let chart: Chart;
    let currentFunds = [];
    let currentFundIndex = 0;
    let years = 20;

    function populateFunds(category) {
        currentFunds = mutualFundsData[category] || [];
        fundSelect.innerHTML = "";
        currentFunds.forEach((fund, index) => {
            const option = document.createElement("option");
            option.value = index.toString();
            option.textContent = fund.fund_name;
            fundSelect.appendChild(option);
        });
        updateFundDetails(0);
    }

    function updateFundDetails(index) {
        currentFundIndex = index;
        const fund = currentFunds[index];
        if (!fund) return;

        if (cagrDisplay)
            cagrDisplay.textContent = `${fund["5_year_cagr_percent"]}%`;
        if (expenseDisplay)
            expenseDisplay.textContent = `${fund.expense_ratio_percent}%`;
        if (fundNameTitle) fundNameTitle.textContent = fund.fund_name;

        updateChart(fund);
    }

    function updateChart(fund) {
        const appState = getState();
        const cagr = fund["5_year_cagr_percent"];
        const expense = fund.expense_ratio_percent;

        const withoutFees = computeCompoundInterest(
            appState.principal,
            cagr,
            years,
        );
        const effectiveRate = cagr - expense;
        const withFees = computeCompoundInterest(
            appState.principal,
            effectiveRate,
            years,
        );

        const labels = Array.from({ length: years + 1 }, (_, idx) => `${idx}y`);

        const lastWithout = withoutFees[withoutFees.length - 1] ?? 0;
        const lastWith = withFees[withFees.length - 1] ?? 0;
        const netLoss = Math.max(lastWithout - lastWith, 0);

        if (lossLabel) lossLabel.textContent = `Projected loss to fees`;
        if (netLossEl) netLossEl.textContent = formatMoney(Math.round(netLoss));

        if (principalDisplay) {
            principalDisplay.textContent = formatMoney(appState.principal);
        }

        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = withoutFees;
            chart.data.datasets[1].data = withFees;
            chart.options.scales.y.ticks.callback = (value) =>
                formatMoney(Number(value));
            chart.options.plugins.tooltip.callbacks.label = (context) =>
                `${context.dataset.label}: ${formatMoney(context.parsed.y)}`;
            chart.options.plugins.tooltip.callbacks.footer = (items) => {
                if (!items.length) return "";
                const withoutFees =
                    items.find((item) => item.datasetIndex === 0)?.parsed.y ??
                    0;
                const withFees =
                    items.find((item) => item.datasetIndex === 1)?.parsed.y ??
                    0;
                const delta = withoutFees - withFees;
                if (!delta) return "";
                return `Difference: ${formatMoney(delta)}`;
            };
            chart.update();
        } else {
            initChart(labels, withoutFees, withFees);
        }
    }

    function initChart(labels, data1, data2) {
        if (!ctx) return;

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Gross Return (No Fees)",
                        borderColor: "#38bdf8",
                        backgroundColor: "rgba(56, 189, 248, 0.15)",
                        borderWidth: 3,
                        tension: 0.3,
                        data: data1,
                    },
                    {
                        label: "Net Return (After Fees)",
                        borderColor: "#fbbf24",
                        backgroundColor: "rgba(251, 191, 36, 0.15)",
                        borderWidth: 3,
                        tension: 0.3,
                        data: data2,
                    },
                ],
            },
            options: {
                animation: false,
                responsive: true,
                interaction: {
                    mode: "index",
                    intersect: false,
                },
                scales: {
                    y: {
                        grid: {
                            color: "rgba(148, 163, 184, 0.15)",
                        },
                        ticks: {
                            color: "#cbd5f5",
                            callback: (value) => formatMoney(Number(value)),
                        },
                    },
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: "#cbd5f5",
                        },
                    },
                },
                plugins: {
                    legend: {
                        labels: {
                            color: "#e2e8f0",
                            usePointStyle: true,
                            pointStyle: "circle",
                        },
                    },
                    tooltip: {
                        usePointStyle: true,
                        callbacks: {
                            label: (context) =>
                                `${context.dataset.label}: ${formatMoney(context.parsed.y)}`,
                            footer: (items) => {
                                if (!items.length) return "";
                                const withoutFees =
                                    items.find(
                                        (item) => item.datasetIndex === 0,
                                    )?.parsed.y ?? 0;
                                const withFees =
                                    items.find(
                                        (item) => item.datasetIndex === 1,
                                    )?.parsed.y ?? 0;
                                const delta = withoutFees - withFees;
                                if (!delta) return "";
                                return `Difference: ${formatMoney(delta)}`;
                            },
                        },
                        footerColor: "#f87171",
                        footerFont: {
                            weight: "600",
                        },
                    },
                },
            },
        });
    }

    categorySelect.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        populateFunds(target.value);
    });

    fundSelect.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        updateFundDetails(Number(target.value));
    });

    if (yearSlider) {
        yearSlider.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            years = Number(target.value);
            if (yearsDisplay) yearsDisplay.textContent = `${years} years`;
            if (currentFunds.length > 0) {
                updateFundDetails(currentFundIndex);
            }
        });
    }

    // Subscribe to store changes
    subscribe((appState) => {
        // Refresh chart if data is loaded
        if (currentFunds.length > 0) {
            updateFundDetails(currentFundIndex);
        }
    });

    // Initial load
    populateFunds("indian_mutual_funds");
</script>

<style>
    .app {
        width: min(1100px, 100%);
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .back-link {
        display: inline-block;
        color: #94a3b8;
        text-decoration: none;
        margin-bottom: 16px;
        font-size: 0.9rem;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: #38bdf8;
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        background: rgba(15, 23, 42, 0.72);
        padding: 20px;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        backdrop-filter: blur(8px);
    }

    .control {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .control__label {
        font-size: 0.85rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .select-input {
        padding: 12px;
        border-radius: 12px;
        background: rgba(2, 6, 23, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        font-size: 1rem;
        cursor: pointer;
        outline: none;
        transition: border-color 0.2s;
    }

    .select-input:focus {
        border-color: #38bdf8;
    }

    .stats-display {
        flex-direction: row;
        gap: 24px;
        align-items: center;
        justify-content: flex-start;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #38bdf8;
    }

    input[type="range"] {
        accent-color: #38bdf8;
        cursor: pointer;
    }

    @media (max-width: 600px) {
        .controls {
            padding: 16px;
            grid-template-columns: 1fr;
        }
    }
</style>
