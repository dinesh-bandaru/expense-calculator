---
import Layout from "../layouts/Layout.astro";
import GlobalControls from "../components/GlobalControls.astro";
import PageHeader from "../components/PageHeader.astro";
import ChartCard from "../components/ChartCard.astro";

let d1Funds: any[] = [];
let debugInfo: any = {};
let error: string | null = null;

try {
    const runtime = Astro.locals.runtime;
    debugInfo = {
        hasLocals: !!Astro.locals,
        hasRuntime: !!runtime,
        hasEnv: !!runtime?.env,
        hasDb: !!runtime?.env?.etf_db,
        envKeys: runtime?.env ? Object.keys(runtime.env) : [],
    };

    if (runtime?.env?.etf_db) {
        const { results } = await runtime.env.etf_db
            .prepare(
                `
                SELECT 
                    t1.symbol, 
                    t1.name, 
                    t2."5yr_cagr" as cagr, 
                    t2.expense_ratio 
                FROM etfs t1 
                LEFT JOIN etf_fundamentals t2 ON t1.symbol = t2.etf
            `,
            )
            .all();
        d1Funds = results || [];
    } else {
        console.warn(
            "D1 database binding not found in runtime. Available keys:",
            Object.keys(runtime?.env || {}),
        );
    }
} catch (e: any) {
    console.error("Failed to fetch from D1", e);
    error = e.message || String(e);
}
---

<Layout>
    <section class="app">
        <PageHeader eyebrow="Compare Funds" title="Analyze Actual Funds">
            <a href="/" slot="back-link" class="back-link">‚Üê Home</a>
            Select a mutual fund to see how its historical 5-year CAGR and expense
            ratio would impact your returns over time.
            <GlobalControls slot="controls" />
        </PageHeader>

        <section class="controls">
            <div class="control">
                <div class="control__label">
                    <label for="fundSelect">Select Fund</label>
                </div>
                <select id="fundSelect" class="select-input">
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="control">
                <div class="control__label">
                    <span>Projection length</span>
                    <span id="yearsDisplay">20 years</span>
                </div>
                <input
                    id="yearSlider"
                    type="range"
                    min="5"
                    max="40"
                    step="1"
                    value="20"
                />
            </div>

            <div class="control stats-display">
                <div class="stat-item">
                    <span class="stat-label">5Y CAGR</span>
                    <span class="stat-value" id="cagrDisplay">--%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Expense Ratio</span>
                    <span class="stat-value" id="expenseDisplay">--%</span>
                </div>
            </div>
        </section>

        <ChartCard title="Fund Name" chartId="fundChart" />

        <div
            id="debug-message"
            style="display: none; color: #f87171; padding: 20px; background: rgba(15, 23, 42, 0.95); border: 1px solid #f87171; border-radius: 8px; margin-top: 20px; font-family: monospace; white-space: pre-wrap;"
        >
        </div>
    </section>
</Layout>

<script define:vars={{ d1Funds, debugInfo, error }}>
    window.d1Funds = d1Funds;
    window.debugInfo = debugInfo;
    window.serverError = error;

    if (error || !d1Funds || d1Funds.length === 0) {
        console.log("Debug Info:", debugInfo);
        console.error("Server Error:", error);

        const el = document.getElementById("debug-message");
        if (el) {
            el.style.display = "block";
            el.innerHTML = `<strong>Debug Info:</strong>\n${JSON.stringify(debugInfo, null, 2)}\n\n<strong>Error:</strong>\n${error || "No error message, but no funds found."}`;
        }
    }
</script>

<script>
    import { Chart, registerables } from "chart.js";
    import { computeCompoundInterest } from "../lib/finance";
    import { getState, setState, subscribe, formatMoney } from "../lib/store";

    Chart.register(...registerables);

    const fundSelect = document.getElementById(
        "fundSelect",
    ) as HTMLSelectElement;
    const yearSlider = document.getElementById(
        "yearSlider",
    ) as HTMLInputElement;
    const yearsDisplay = document.getElementById("yearsDisplay");
    const cagrDisplay = document.getElementById("cagrDisplay");
    const expenseDisplay = document.getElementById("expenseDisplay");
    const fundNameTitle = document.getElementById("chartTitle");
    const netLossEl = document.getElementById("netLossValue");
    const lossLabel = document.getElementById("lossLabel");
    const ctx = document.getElementById("fundChart") as HTMLCanvasElement;
    const principalDisplay = document.getElementById("principalDisplay");

    let chart: Chart;
    let currentFunds: any[] = [];
    let currentFundIndex = 0;
    let years = 20;

    // Use D1 funds directly
    const d1Funds: any[] = (window as any).d1Funds || [];
    currentFunds = d1Funds.map((fund: any) => ({
        fund_name: fund.name,
        symbol: fund.symbol,
        "5_year_cagr_percent": Math.round(fund.cagr * 100 * 100) / 100,
        expense_ratio_percent: Math.round(fund.expense_ratio * 100 * 100) / 100,
    }));

    function populateFunds(defaultFundName: string | null = null) {
        fundSelect.innerHTML = "";
        let defaultIndex = 0;

        currentFunds.forEach((fund, index) => {
            const option = document.createElement("option");
            option.value = index.toString();
            option.textContent = fund.fund_name;
            fundSelect.appendChild(option);

            if (defaultFundName && fund.fund_name === defaultFundName) {
                defaultIndex = index;
            }
        });

        fundSelect.value = defaultIndex.toString();
        updateFundDetails(defaultIndex);
    }

    function updateFundDetails(index: number) {
        currentFundIndex = index;
        const fund = currentFunds[index];
        if (!fund) return;

        if (cagrDisplay)
            cagrDisplay.textContent = `${fund["5_year_cagr_percent"]}%`;
        if (expenseDisplay)
            expenseDisplay.textContent = `${fund.expense_ratio_percent}%`;
        if (fundNameTitle) fundNameTitle.textContent = fund.fund_name;

        updateChart(fund);
    }

    function updateChart(fund: any) {
        const appState = getState();
        const cagr = fund["5_year_cagr_percent"];
        const expense = fund.expense_ratio_percent;

        const withoutFees = computeCompoundInterest(
            appState.principal,
            cagr,
            years,
        );
        const effectiveRate = cagr - expense;
        const withFees = computeCompoundInterest(
            appState.principal,
            effectiveRate,
            years,
        );

        const labels = Array.from({ length: years + 1 }, (_, idx) => `${idx}y`);

        const lastWithout = withoutFees[withoutFees.length - 1] ?? 0;
        const lastWith = withFees[withFees.length - 1] ?? 0;
        const netLoss = Math.max(lastWithout - lastWith, 0);

        if (lossLabel) lossLabel.textContent = `Projected loss to fees`;
        if (netLossEl) netLossEl.textContent = formatMoney(Math.round(netLoss));

        if (principalDisplay) {
            principalDisplay.textContent = formatMoney(appState.principal);
        }

        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = withoutFees;
            chart.data.datasets[1].data = withFees;
            chart.options.scales.y.ticks.callback = (value) =>
                formatMoney(Number(value));
            chart.options.plugins.tooltip.callbacks.label = (context) =>
                `${context.dataset.label}: ${formatMoney(context.parsed.y)}`;
            chart.options.plugins.tooltip.callbacks.footer = (items) => {
                if (!items.length) return "";
                const withoutFees =
                    items.find((item) => item.datasetIndex === 0)?.parsed.y ??
                    0;
                const withFees =
                    items.find((item) => item.datasetIndex === 1)?.parsed.y ??
                    0;
                const delta = withoutFees - withFees;
                if (!delta) return "";
                return `Difference: ${formatMoney(delta)}`;
            };
            chart.update();
        } else {
            initChart(labels, withoutFees, withFees);
        }
    }

    function initChart(labels: string[], data1: number[], data2: number[]) {
        if (!ctx) return;

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Gross Return (No Fees)",
                        borderColor: "#4ade80",
                        backgroundColor: "rgba(74, 222, 128, 0.15)",
                        borderWidth: 3,
                        tension: 0.3,
                        data: data1,
                    },
                    {
                        label: "Net Return (After Fees)",
                        borderColor: "#f87171",
                        backgroundColor: "rgba(248, 113, 113, 0.15)",
                        borderWidth: 3,
                        tension: 0.3,
                        data: data2,
                    },
                ],
            },
            options: {
                animation: false,
                responsive: true,
                interaction: {
                    mode: "index",
                    intersect: false,
                },
                scales: {
                    y: {
                        grid: {
                            color: "rgba(148, 163, 184, 0.15)",
                        },
                        ticks: {
                            color: "#cbd5f5",
                            callback: (value) => formatMoney(Number(value)),
                        },
                    },
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: "#cbd5f5",
                        },
                    },
                },
                plugins: {
                    legend: {
                        labels: {
                            color: "#e2e8f0",
                            usePointStyle: true,
                            pointStyle: "circle",
                        },
                    },
                    tooltip: {
                        usePointStyle: true,
                        callbacks: {
                            label: (context) =>
                                `${context.dataset.label}: ${formatMoney(context.parsed.y)}`,
                            footer: (items) => {
                                if (!items.length) return "";
                                const withoutFees =
                                    items.find(
                                        (item) => item.datasetIndex === 0,
                                    )?.parsed.y ?? 0;
                                const withFees =
                                    items.find(
                                        (item) => item.datasetIndex === 1,
                                    )?.parsed.y ?? 0;
                                const delta = withoutFees - withFees;
                                if (!delta) return "";
                                return `Difference: ${formatMoney(delta)}`;
                            },
                        },
                        footerColor: "#f87171",
                        footerFont: {
                            weight: "bold",
                        },
                    },
                },
            },
        });
    }

    fundSelect.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        updateFundDetails(Number(target.value));
    });

    if (yearSlider) {
        yearSlider.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            years = Number(target.value);
            if (yearsDisplay) yearsDisplay.textContent = `${years} years`;
            if (currentFunds.length > 0) {
                updateFundDetails(currentFundIndex);
            }
        });
    }

    // Subscribe to store changes
    subscribe((appState) => {
        // Refresh chart if data is loaded
        if (currentFunds.length > 0) {
            updateFundDetails(currentFundIndex);
        }
    });

    // Initial load
    populateFunds();
</script>

<style>
    .app {
        width: min(1100px, 100%);
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .back-link {
        display: inline-block;
        color: #94a3b8;
        text-decoration: none;
        margin-bottom: 16px;
        font-size: 0.9rem;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: #4ade80;
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        background: rgba(15, 23, 42, 0.72);
        padding: 20px;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        backdrop-filter: blur(8px);
    }

    .control {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .control__label {
        font-size: 0.85rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .select-input {
        padding: 12px;
        border-radius: 12px;
        background: rgba(2, 6, 23, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        font-size: 1rem;
        cursor: pointer;
        outline: none;
        transition: border-color 0.2s;
    }

    .select-input:focus {
        border-color: #4ade80;
    }

    .stats-display {
        flex-direction: row;
        gap: 24px;
        align-items: center;
        justify-content: flex-start;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #4ade80;
    }

    input[type="range"] {
        accent-color: #4ade80;
        cursor: pointer;
    }

    @media (max-width: 600px) {
        .controls {
            padding: 16px;
            grid-template-columns: 1fr;
        }
    }
</style>
