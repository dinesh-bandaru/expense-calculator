---
import Layout from "../layouts/Layout.astro";
---

<Layout>
    <section class="app">
        <header class="intro">
            <div>
                <a href="/" class="back-link">← Back to Simulator</a>
                <p class="eyebrow">Real World Data</p>
                <h1>Analyze Actual Funds</h1>
                <p class="description">
                    Select a mutual fund to see how its historical 5-year CAGR
                    and expense ratio would impact your returns over time.
                </p>

                <div class="global-controls">
                    <div class="input-group">
                        <label for="principalInput">Principal Amount</label>
                        <input
                            type="number"
                            id="principalInput"
                            min="1000"
                            step="1000"
                        />
                    </div>
                    <div class="input-group">
                        <label for="currencySelect">Currency</label>
                        <select id="currencySelect">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="INR">INR (₹)</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <section class="controls">
            <div class="control">
                <div class="control__label">
                    <label for="categorySelect">Fund Category</label>
                </div>
                <select id="categorySelect" class="select-input">
                    <option value="indian_mutual_funds"
                        >Indian Mutual Funds</option
                    >
                    <option value="american_mutual_funds_and_etfs"
                        >American Funds & ETFs</option
                    >
                </select>
            </div>

            <div class="control">
                <div class="control__label">
                    <label for="fundSelect">Select Fund</label>
                </div>
                <select id="fundSelect" class="select-input">
                    <!-- Populated by JS -->
                </select>
            </div>

            <div class="control">
                <div class="control__label">
                    <span>Projection length</span>
                    <span id="yearsDisplay">20 years</span>
                </div>
                <input
                    id="yearSlider"
                    type="range"
                    min="5"
                    max="40"
                    step="1"
                    value="20"
                />
            </div>

            <div class="control stats-display">
                <div class="stat-item">
                    <span class="stat-label">5Y CAGR</span>
                    <span class="stat-value" id="cagrDisplay">--%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Expense Ratio</span>
                    <span class="stat-value" id="expenseDisplay">--%</span>
                </div>
            </div>
        </section>

        <section class="chart-card">
            <div class="chart-header">
                <div>
                    <p class="eyebrow">Projected Growth</p>
                    <h2 id="fundNameTitle">Fund Name</h2>
                </div>
                <div class="chart-header-right">
                    <p class="principal">
                        Starting with <span id="principalDisplay">--</span>
                    </p>
                    <p class="loss-pill">
                        <span class="loss-label" id="lossLabel"
                            >Projected loss to fees (20y)</span
                        >
                        <span id="netLossValue" class="loss-value">0</span>
                    </p>
                </div>
            </div>
            <canvas
                id="fundChart"
                width="640"
                height="360"
                aria-label="Fund growth chart"></canvas>
        </section>
    </section>
</Layout>

<script>
    import { Chart, registerables } from "chart.js";
    import { computeCompoundInterest } from "../lib/finance";
    import mutualFundsData from "../data/mutualfunds.json";
    import { getState, setState, subscribe, formatMoney } from "../lib/store";

    Chart.register(...registerables);

    const categorySelect = document.getElementById(
        "categorySelect",
    ) as HTMLSelectElement;
    const fundSelect = document.getElementById(
        "fundSelect",
    ) as HTMLSelectElement;
    const yearSlider = document.getElementById(
        "yearSlider",
    ) as HTMLInputElement;
    const yearsDisplay = document.getElementById("yearsDisplay");
    const cagrDisplay = document.getElementById("cagrDisplay");
    const expenseDisplay = document.getElementById("expenseDisplay");
    const fundNameTitle = document.getElementById("fundNameTitle");
    const netLossEl = document.getElementById("netLossValue");
    const lossLabel = document.getElementById("lossLabel");
    const ctx = document.getElementById("fundChart") as HTMLCanvasElement;
    const principalDisplay = document.getElementById("principalDisplay");

    const globalInputs = {
        principal: document.getElementById(
            "principalInput",
        ) as HTMLInputElement,
        currency: document.getElementById(
            "currencySelect",
        ) as HTMLSelectElement,
    };

    let chart: Chart;
    let currentFunds = [];
    let currentFundIndex = 0;
    let years = 20;

    function populateFunds(category) {
        currentFunds = mutualFundsData[category] || [];
        fundSelect.innerHTML = "";
        currentFunds.forEach((fund, index) => {
            const option = document.createElement("option");
            option.value = index.toString();
            option.textContent = fund.fund_name;
            fundSelect.appendChild(option);
        });
        updateFundDetails(0);
    }

    function updateFundDetails(index) {
        currentFundIndex = index;
        const fund = currentFunds[index];
        if (!fund) return;

        if (cagrDisplay)
            cagrDisplay.textContent = `${fund["5_year_cagr_percent"]}%`;
        if (expenseDisplay)
            expenseDisplay.textContent = `${fund.expense_ratio_percent}%`;
        if (fundNameTitle) fundNameTitle.textContent = fund.fund_name;

        updateChart(fund);
    }

    function updateChart(fund) {
        const appState = getState();
        const cagr = fund["5_year_cagr_percent"];
        const expense = fund.expense_ratio_percent;

        const withoutFees = computeCompoundInterest(
            appState.principal,
            cagr,
            years,
        );
        const effectiveRate = cagr - expense;
        const withFees = computeCompoundInterest(
            appState.principal,
            effectiveRate,
            years,
        );

        const labels = Array.from({ length: years + 1 }, (_, idx) => `${idx}y`);

        const lastWithout = withoutFees[withoutFees.length - 1] ?? 0;
        const lastWith = withFees[withFees.length - 1] ?? 0;
        const netLoss = Math.max(lastWithout - lastWith, 0);

        if (lossLabel)
            lossLabel.textContent = `Projected loss to fees (${years}y)`;
        if (netLossEl) netLossEl.textContent = formatMoney(Math.round(netLoss));

        if (principalDisplay) {
            principalDisplay.textContent = formatMoney(appState.principal);
        }

        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = withoutFees;
            chart.data.datasets[1].data = withFees;
            chart.options.scales.y.ticks.callback = (value) =>
                formatMoney(Number(value));
            chart.options.plugins.tooltip.callbacks.label = (context) =>
                `${context.dataset.label}: ${formatMoney(context.parsed.y)}`;
            chart.options.plugins.tooltip.callbacks.footer = (items) => {
                if (!items.length) return "";
                const withoutFees =
                    items.find((item) => item.datasetIndex === 0)?.parsed.y ??
                    0;
                const withFees =
                    items.find((item) => item.datasetIndex === 1)?.parsed.y ??
                    0;
                const delta = withoutFees - withFees;
                if (!delta) return "";
                return `Difference: ${formatMoney(delta)}`;
            };
            chart.update();
        } else {
            initChart(labels, withoutFees, withFees);
        }
    }

    function initChart(labels, data1, data2) {
        if (!ctx) return;

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Gross Return (No Fees)",
                        borderColor: "#38bdf8",
                        backgroundColor: "rgba(56, 189, 248, 0.15)",
                        borderWidth: 3,
                        tension: 0.3,
                        data: data1,
                    },
                    {
                        label: "Net Return (After Fees)",
                        borderColor: "#fbbf24",
                        backgroundColor: "rgba(251, 191, 36, 0.15)",
                        borderWidth: 3,
                        tension: 0.3,
                        data: data2,
                    },
                ],
            },
            options: {
                animation: false,
                responsive: true,
                interaction: {
                    mode: "index",
                    intersect: false,
                },
                scales: {
                    y: {
                        grid: {
                            color: "rgba(148, 163, 184, 0.15)",
                        },
                        ticks: {
                            color: "#cbd5f5",
                            callback: (value) => formatMoney(Number(value)),
                        },
                    },
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: "#cbd5f5",
                        },
                    },
                },
                plugins: {
                    legend: {
                        labels: {
                            color: "#e2e8f0",
                            usePointStyle: true,
                            pointStyle: "circle",
                        },
                    },
                    tooltip: {
                        usePointStyle: true,
                        callbacks: {
                            label: (context) =>
                                `${context.dataset.label}: ${formatMoney(context.parsed.y)}`,
                            footer: (items) => {
                                if (!items.length) return "";
                                const withoutFees =
                                    items.find(
                                        (item) => item.datasetIndex === 0,
                                    )?.parsed.y ?? 0;
                                const withFees =
                                    items.find(
                                        (item) => item.datasetIndex === 1,
                                    )?.parsed.y ?? 0;
                                const delta = withoutFees - withFees;
                                if (!delta) return "";
                                return `Difference: ${formatMoney(delta)}`;
                            },
                        },
                        footerColor: "#f87171",
                        footerFont: {
                            weight: "600",
                        },
                    },
                },
            },
        });
    }

    categorySelect.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        populateFunds(target.value);
    });

    fundSelect.addEventListener("change", (e) => {
        const target = e.target as HTMLSelectElement;
        updateFundDetails(Number(target.value));
    });

    if (yearSlider) {
        yearSlider.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            years = Number(target.value);
            if (yearsDisplay) yearsDisplay.textContent = `${years} years`;
            if (currentFunds.length > 0) {
                updateFundDetails(currentFundIndex);
            }
        });
    }

    // Global controls listeners
    if (globalInputs.principal) {
        globalInputs.principal.addEventListener("input", (e) => {
            const target = e.target as HTMLInputElement;
            setState({ principal: Number(target.value) });
        });
    }

    if (globalInputs.currency) {
        globalInputs.currency.addEventListener("change", (e) => {
            const target = e.target as HTMLSelectElement;
            setState({ currency: target.value as any });
        });
    }

    // Subscribe to store changes
    subscribe((appState) => {
        if (
            globalInputs.principal &&
            document.activeElement !== globalInputs.principal
        ) {
            globalInputs.principal.value = appState.principal.toString();
        }
        if (globalInputs.currency) {
            globalInputs.currency.value = appState.currency;
        }

        // Refresh chart if data is loaded
        if (currentFunds.length > 0) {
            updateFundDetails(currentFundIndex);
        }
    });

    // Initial load
    populateFunds("indian_mutual_funds");
</script>

<style>
    .app {
        width: min(1100px, 100%);
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .back-link {
        display: inline-block;
        color: #94a3b8;
        text-decoration: none;
        margin-bottom: 16px;
        font-size: 0.9rem;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: #38bdf8;
    }

    .eyebrow {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.3em;
        color: #38bdf8;
        margin-bottom: 0.4rem;
    }

    h1 {
        margin: 0 0 0.5rem;
        font-size: clamp(2rem, 4vw, 3.25rem);
    }

    h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .description {
        max-width: 60ch;
        color: #cbd5f5;
        margin: 0 0 24px;
        line-height: 1.6;
    }

    .global-controls {
        display: flex;
        gap: 16px;
        margin-top: 24px;
        flex-wrap: wrap;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .input-group label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #94a3b8;
    }

    .input-group input,
    .input-group select {
        padding: 10px 16px;
        border-radius: 8px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s;
    }

    .input-group input:focus,
    .input-group select:focus {
        border-color: #38bdf8;
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        background: rgba(15, 23, 42, 0.72);
        padding: 20px;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.15);
        backdrop-filter: blur(8px);
    }

    .control {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .control__label {
        font-size: 0.85rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .select-input {
        padding: 12px;
        border-radius: 12px;
        background: rgba(2, 6, 23, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        font-size: 1rem;
        cursor: pointer;
        outline: none;
        transition: border-color 0.2s;
    }

    .select-input:focus {
        border-color: #38bdf8;
    }

    .stats-display {
        flex-direction: row;
        gap: 24px;
        align-items: center;
        justify-content: flex-start;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #38bdf8;
    }

    .chart-card {
        background: rgba(2, 6, 23, 0.85);
        border-radius: 24px;
        padding: 24px;
        border: 1px solid rgba(56, 189, 248, 0.25);
        box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.7);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        gap: 16px;
    }

    .principal {
        color: #94a3b8;
        margin: 0;
        font-size: 0.95rem;
    }

    .chart-header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        text-align: right;
    }

    .loss-pill {
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
        margin: 0;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .loss-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #fecaca;
    }

    .loss-value {
        font-weight: 600;
        color: #fecaca;
        font-variant-numeric: tabular-nums;
    }

    canvas {
        width: 100% !important;
        height: auto !important;
    }

    input[type="range"] {
        accent-color: #38bdf8;
        cursor: pointer;
    }

    @media (max-width: 600px) {
        .controls {
            padding: 16px;
            grid-template-columns: 1fr;
        }

        .chart-card {
            padding: 18px;
        }

        .chart-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
