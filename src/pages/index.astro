---
import Layout from "../layouts/Layout.astro";
---

<Layout>
	<section class="app">
		<a href="/funds" class="glowing-pill">
			<span class="glowing-pill-content">
				View Real World Data <span class="arrow">→</span>
			</span>
		</a>
		<header class="intro">
			<div>
				<p class="eyebrow">Fund projection</p>
				<h1>See how fees chip away at compounding</h1>
				<p class="description">
					Use the sliders to explore how an annual expense ratio
					reduces long-term growth compared to a fee-free version of
					the same fund.
				</p>

				<div class="global-controls">
					<div class="input-group">
						<label for="principalInput">Principal Amount</label>
						<input
							type="number"
							id="principalInput"
							value="100000"
							min="1000"
							step="1000"
						/>
					</div>
					<div class="input-group">
						<label for="currencySelect">Currency</label>
						<select id="currencySelect">
							<option value="USD">USD ($)</option>
							<option value="EUR">EUR (€)</option>
							<option value="GBP">GBP (£)</option>
							<option value="INR">INR (₹)</option>
						</select>
					</div>
				</div>
			</div>
		</header>

		<section class="controls">
			<div class="control">
				<div class="control__label">
					<span>CAGR</span>
					<span data-output="cagr">0%</span>
				</div>
				<input
					id="cagrSlider"
					type="range"
					min="2"
					max="25"
					step="0.1"
					value="12"
				/>
			</div>

			<div class="control">
				<div class="control__label">
					<span>Expense ratio</span>
					<span data-output="expense">0%</span>
				</div>
				<input
					id="expenseSlider"
					type="range"
					min="0"
					max="3"
					step="0.05"
					value="0.8"
				/>
			</div>

			<div class="control">
				<div class="control__label">
					<span>Projection length</span>
					<span data-output="years">0 years</span>
				</div>
				<input
					id="yearSlider"
					type="range"
					min="5"
					max="40"
					step="1"
					value="20"
				/>
			</div>
		</section>

		<div class="chart-card">
			<div class="chart-header">
				<div>
					<p class="eyebrow">Projected Growth</p>
					<h2>Your Projection</h2>
				</div>
				<div class="chart-header-right">
					<p class="principal">
						Starting with <span id="principalDisplay">--</span>
					</p>
					<p class="loss-pill">
						<span class="loss-label">Projected loss to fees</span>
						<span id="netLossValue" class="loss-value">0</span>
					</p>
				</div>
			</div>
			<canvas
				id="growthChart"
				width="640"
				height="360"
				aria-label="Growth chart"></canvas>
		</div>
	</section>
</Layout>

<script>
	import { Chart, registerables } from "chart.js";
	import { computeCompoundInterest } from "../lib/finance";
	import { getState, setState, subscribe, formatMoney } from "../lib/store";

	Chart.register(...registerables);

	const state = {
		cagr: 12,
		expense: 0.8,
		years: 20,
	};

	const sliders = {
		cagr: document.querySelector("#cagrSlider"),
		expense: document.querySelector("#expenseSlider"),
		years: document.querySelector("#yearSlider"),
	};

	const globalInputs = {
		principal: document.querySelector("#principalInput"),
		currency: document.querySelector("#currencySelect"),
	};

	const outputs = {
		cagr: document.querySelector('[data-output="cagr"]'),
		expense: document.querySelector('[data-output="expense"]'),
		years: document.querySelector('[data-output="years"]'),
	};

	const ctx = document.getElementById("growthChart") as HTMLCanvasElement;
	const netLossEl = document.getElementById("netLossValue");
	const principalDisplay = document.getElementById("principalDisplay");
	let animatedNetLoss = 0;
	let chart;

	if (ctx) {
		chart = new Chart(ctx, {
			type: "line",
			data: {
				labels: [],
				datasets: [
					{
						label: "Without fees",
						borderColor: "#38bdf8",
						backgroundColor: "rgba(56, 189, 248, 0.15)",
						borderWidth: 3,
						tension: 0.3,
						data: [],
					},
					{
						label: "With expense ratio",
						borderColor: "#fbbf24",
						backgroundColor: "rgba(251, 191, 36, 0.15)",
						borderWidth: 3,
						tension: 0.3,
						data: [],
					},
				],
			},
			options: {
				animation: false,
				responsive: true,
				interaction: {
					mode: "index",
					intersect: false,
				},
				scales: {
					y: {
						grid: {
							color: "rgba(148, 163, 184, 0.15)",
						},
						ticks: {
							color: "#cbd5f5",
							callback: (value) => formatMoney(Number(value)),
						},
					},
					x: {
						grid: {
							display: false,
						},
						ticks: {
							color: "#cbd5f5",
						},
					},
				},
				plugins: {
					legend: {
						labels: {
							color: "#e2e8f0",
							usePointStyle: true,
							pointStyle: "circle",
						},
					},
					tooltip: {
						usePointStyle: true,
						callbacks: {
							label: (context) =>
								`${context.dataset.label}: ${formatMoney(context.parsed.y)}`,
							footer: (items) => {
								if (!items.length) return "";
								const withoutFees =
									items.find(
										(item) => item.datasetIndex === 0,
									)?.parsed.y ?? 0;
								const withFees =
									items.find(
										(item) => item.datasetIndex === 1,
									)?.parsed.y ?? 0;
								const delta = withoutFees - withFees;
								if (!delta) return "";
								return `Difference: ${formatMoney(delta)}`;
							},
						},
						footerColor: "#f87171",
						footerFont: {
							weight: "600",
						},
					},
				},
			},
		});
	}

	function animateNetLoss(target) {
		const start = animatedNetLoss;
		const duration = 500;
		const startTime = performance.now();

		function frame(now) {
			const t = Math.min((now - startTime) / duration, 1);
			const eased = 1 - Math.pow(1 - t, 3);
			animatedNetLoss = start + (target - start) * eased;
			if (netLossEl) {
				netLossEl.textContent = formatMoney(
					Math.round(animatedNetLoss),
				);
			}
			if (t < 1) requestAnimationFrame(frame);
		}

		requestAnimationFrame(frame);
	}

	function refreshChart() {
		const appState = getState();
		const labels = Array.from(
			{ length: state.years + 1 },
			(_, idx) => `${idx}y`,
		);
		chart.data.labels = labels;

		const withoutFees = computeCompoundInterest(
			appState.principal,
			state.cagr,
			state.years,
		);
		const effectiveRate = state.cagr - state.expense;
		const withFees = computeCompoundInterest(
			appState.principal,
			effectiveRate,
			state.years,
		);

		chart.data.datasets[0].data = withoutFees;
		chart.data.datasets[1].data = withFees;

		const lastWithout = withoutFees[withoutFees.length - 1] ?? 0;
		const lastWith = withFees[withFees.length - 1] ?? 0;
		const netLoss = Math.max(lastWithout - lastWith, 0);
		animateNetLoss(netLoss);
		chart.update();

		if (principalDisplay) {
			principalDisplay.textContent = `Starting with ${formatMoney(appState.principal)}`;
		}
	}

	function updateOutputs() {
		outputs.cagr.textContent = `${state.cagr.toFixed(1)}%`;
		outputs.expense.textContent = `${state.expense.toFixed(2)}%`;
		outputs.years.textContent = `${state.years} years`;
	}

	Object.entries(sliders).forEach(([key, input]) => {
		input.addEventListener("input", () => {
			const value = parseFloat(input.value);
			state[key] = key === "years" ? Math.round(value) : value;

			updateOutputs();
			refreshChart();
		});
	});

	// Global controls listeners
	if (globalInputs.principal) {
		globalInputs.principal.addEventListener("input", (e) => {
			const target = e.target as HTMLInputElement;
			setState({ principal: Number(target.value) });
		});
	}

	if (globalInputs.currency) {
		globalInputs.currency.addEventListener("change", (e) => {
			const target = e.target as HTMLSelectElement;
			setState({ currency: target.value as any });
		});
	}

	// Subscribe to store changes
	subscribe((appState) => {
		if (
			globalInputs.principal &&
			document.activeElement !== globalInputs.principal
		) {
			(globalInputs.principal as HTMLInputElement).value =
				appState.principal.toString();
		}
		if (globalInputs.currency) {
			(globalInputs.currency as HTMLSelectElement).value =
				appState.currency;
		}
		refreshChart();
	});

	updateOutputs();
</script>

<style>
	.app {
		width: min(1100px, 100%);
		display: flex;
		flex-direction: column;
		gap: 32px;
	}

	.glowing-pill {
		align-self: flex-end;
		position: relative;
		display: inline-flex;
		padding: 1px;
		border-radius: 9999px;
		text-decoration: none;
		overflow: hidden;
		margin-bottom: -20px; /* Pull it up a bit or let it sit */
	}

	.glowing-pill::before {
		content: "";
		position: absolute;
		inset: -100%;
		background: conic-gradient(
			from 0deg,
			transparent 0deg,
			transparent 80deg,
			white 180deg,
			transparent 280deg,
			transparent 360deg
		);
		animation: spin 3s linear infinite;
	}

	.glowing-pill-content {
		position: relative;
		z-index: 1;
		background: #0f172a;
		padding: 8px 16px;
		border-radius: 9999px;
		color: #e2e8f0;
		font-size: 0.85rem;
		font-weight: 500;
		display: flex;
		align-items: center;
		gap: 6px;
		transition: color 0.2s;
	}

	.glowing-pill:hover .glowing-pill-content {
		color: #fff;
	}

	.arrow {
		transition: transform 0.2s;
	}

	.glowing-pill:hover .arrow {
		transform: translateX(2px);
	}

	@keyframes spin {
		from {
			transform: rotate(0deg);
		}
		to {
			transform: rotate(360deg);
		}
	}

	.eyebrow {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.3em;
		color: #38bdf8;
		margin-bottom: 0.4rem;
	}

	h1 {
		margin: 0 0 0.5rem;
		font-size: clamp(2rem, 4vw, 3.25rem);
	}

	h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.description {
		max-width: 60ch;
		color: #cbd5f5;
		margin: 0;
		line-height: 1.6;
	}

	.global-controls {
		display: flex;
		gap: 16px;
		margin-top: 24px;
		flex-wrap: wrap;
	}

	.input-group {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.input-group label {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		color: #94a3b8;
	}

	.input-group input,
	.input-group select {
		padding: 10px 16px;
		border-radius: 8px;
		background: rgba(15, 23, 42, 0.6);
		border: 1px solid rgba(148, 163, 184, 0.2);
		color: #e2e8f0;
		font-size: 0.95rem;
		outline: none;
		transition: border-color 0.2s;
	}

	.input-group input:focus,
	.input-group select:focus {
		border-color: #38bdf8;
	}

	.controls {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 16px;
		background: rgba(15, 23, 42, 0.72);
		padding: 20px;
		border-radius: 20px;
		border: 1px solid rgba(148, 163, 184, 0.15);
		backdrop-filter: blur(8px);
	}

	.control {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.control__label {
		display: flex;
		justify-content: space-between;
		font-size: 0.95rem;
		color: #e2e8f0;
	}

	input[type="range"] {
		accent-color: #38bdf8;
		cursor: pointer;
	}

	.chart-card {
		background: rgba(2, 6, 23, 0.85);
		border-radius: 24px;
		padding: 24px;
		border: 1px solid rgba(56, 189, 248, 0.25);
		box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.7);
	}

	.chart-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 16px;
		gap: 16px;
	}

	.principal {
		color: #94a3b8;
		margin: 0;
		font-size: 0.95rem;
	}

	.chart-header-right {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 4px;
		text-align: right;
	}

	.loss-pill {
		display: inline-flex;
		align-items: baseline;
		gap: 6px;
		margin: 0;
		padding: 4px 10px;
		border-radius: 999px;
		background: rgba(239, 68, 68, 0.12);
		border: 1px solid rgba(239, 68, 68, 0.4);
	}

	.loss-label {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.12em;
		color: #fecaca;
	}

	.loss-value {
		font-weight: 600;
		color: #fecaca;
		font-variant-numeric: tabular-nums;
	}

	.chart-card {
		background: rgba(2, 6, 23, 0.85);
		border-radius: 24px;
		padding: 24px;
		border: 1px solid rgba(56, 189, 248, 0.25);
		box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.7);
	}

	.chart-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 16px;
		gap: 16px;
	}

	.principal {
		color: #94a3b8;
		margin: 0;
		font-size: 0.95rem;
	}

	.chart-header-right {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 4px;
		text-align: right;
	}

	.loss-pill {
		display: inline-flex;
		align-items: baseline;
		gap: 6px;
		margin: 0;
		padding: 4px 10px;
		border-radius: 999px;
		background: rgba(239, 68, 68, 0.12);
		border: 1px solid rgba(239, 68, 68, 0.4);
	}

	.loss-label {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.12em;
		color: #fecaca;
	}

	.loss-value {
		font-weight: 600;
		color: #fecaca;
		font-variant-numeric: tabular-nums;
	}

	canvas {
		width: 100% !important;
		height: auto !important;
	}

	@media (max-width: 600px) {
		.controls {
			padding: 16px;
		}

		.chart-card {
			padding: 18px;
		}

		.chart-header {
			flex-direction: column;
			align-items: flex-start;
		}
	}
</style>
