---
import Layout from '../layouts/Layout.astro';

const principal = 100_000;
const formattedPrincipal = principal.toLocaleString('en-US');
---
<Layout>
	<section class="app" data-principal={principal}>
		<header class="intro">
			<div>
				<p class="eyebrow">Fund projection</p>
				<h1>See how fees chip away at compounding</h1>
				<p class="description">
					Use the sliders to explore how an annual expense ratio reduces long-term growth compared to
					a fee-free version of the same fund. We assume an initial investment of ${formattedPrincipal}.
				</p>
			</div>
		</header>

		<section class="controls">
			<div class="control">
				<div class="control__label">
					<span>CAGR</span>
					<span data-output="cagr">0%</span>
				</div>
				<input id="cagrSlider" type="range" min="2" max="25" step="0.1" value="12" />
			</div>

			<div class="control">
				<div class="control__label">
					<span>Expense ratio</span>
					<span data-output="expense">0%</span>
				</div>
				<input id="expenseSlider" type="range" min="0" max="3" step="0.05" value="0.8" />
			</div>

			<div class="control">
				<div class="control__label">
					<span>Projection length</span>
					<span data-output="years">0 years</span>
				</div>
				<input id="yearSlider" type="range" min="5" max="40" step="1" value="20" />
			</div>
		</section>

		<section class="chart-card">
			<div class="chart-header">
				<div>
					<p class="eyebrow">Balance after fees</p>
					<h2>Projected value over time</h2>
				</div>
				<p class="principal">Starting with ${formattedPrincipal}</p>
			</div>
			<canvas id="growthChart" width="640" height="360" aria-label="Growth chart"></canvas>
		</section>
	</section>
</Layout>

<script type="module">
	import { Chart, registerables } from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.6/+esm';

	Chart.register(...registerables);

	const principal = Number(document.querySelector('.app')?.dataset.principal ?? 0);
	const state = {
		cagr: 12,
		expense: 0.8,
		years: 20
	};

	const currency = new Intl.NumberFormat('en-US', {
		style: 'currency',
		currency: 'USD',
		maximumFractionDigits: 0
	});

	const sliders = {
		cagr: document.querySelector('#cagrSlider'),
		expense: document.querySelector('#expenseSlider'),
		years: document.querySelector('#yearSlider')
	};

	const outputs = {
		cagr: document.querySelector('[data-output="cagr"]'),
		expense: document.querySelector('[data-output="expense"]'),
		years: document.querySelector('[data-output="years"]')
	};

	const ctx = document.getElementById('growthChart');

	const chart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: [],
			datasets: [
				{
					label: 'Without fees',
					borderColor: '#38bdf8',
					backgroundColor: 'rgba(56, 189, 248, 0.15)',
					borderWidth: 3,
					tension: 0.3,
					data: []
				},
				{
					label: 'With expense ratio',
					borderColor: '#fbbf24',
					backgroundColor: 'rgba(251, 191, 36, 0.15)',
					borderWidth: 3,
					tension: 0.3,
					data: []
				}
			]
		},
		options: {
			animation: false,
			responsive: true,
			interaction: {
				mode: 'index',
				intersect: false
			},
			scales: {
				y: {
					grid: {
						color: 'rgba(148, 163, 184, 0.15)'
					},
					ticks: {
						color: '#cbd5f5',
						callback: (value) => currency.format(value)
					}
				},
				x: {
					grid: {
						display: false
					},
					ticks: {
						color: '#cbd5f5'
					}
				}
			},
			plugins: {
				legend: {
					labels: {
						color: '#e2e8f0'
					}
				},
				tooltip: {
					callbacks: {
						label: (context) => `${context.dataset.label}: ${currency.format(context.parsed.y)}`,
						footer: (items) => {
							if (!items.length) return '';
							const withoutFees = items.find((item) => item.datasetIndex === 0)?.parsed.y ?? 0;
							const withFees = items.find((item) => item.datasetIndex === 1)?.parsed.y ?? 0;
							const delta = withoutFees - withFees;
							if (!delta) return '';
							return `Difference: ${currency.format(delta)}`;
						}
					},
					footerColor: '#f87171',
					footerFont: {
						weight: '600'
					}
				}
			}
		}
	});

	function computeSeries(ratePercent) {
		const rate = ratePercent / 100;
		const values = [];

		for (let year = 0; year <= state.years; year += 1) {
			const amount = principal * Math.pow(1 + rate, year);
			values.push(Math.round(amount));
		}

		return values;
	}

	function refreshChart() {
		const labels = Array.from({ length: state.years + 1 }, (_, idx) => `${idx}y`);
		chart.data.labels = labels;
		chart.data.datasets[0].data = computeSeries(state.cagr);
		const effectiveRate = state.cagr - state.expense;
		chart.data.datasets[1].data = computeSeries(effectiveRate);
		chart.update();
	}

	function updateOutputs() {
		outputs.cagr.textContent = `${state.cagr.toFixed(1)}%`;
		outputs.expense.textContent = `${state.expense.toFixed(2)}%`;
		outputs.years.textContent = `${state.years} years`;
	}

	Object.entries(sliders).forEach(([key, input]) => {
		input.addEventListener('input', () => {
			const value = parseFloat(input.value);
			state[key] = key === 'years' ? Math.round(value) : value;

			updateOutputs();
			refreshChart();
		});
	});

	updateOutputs();
	refreshChart();
</script>

<style>
	.app {
		width: min(1100px, 100%);
		display: flex;
		flex-direction: column;
		gap: 32px;
	}

	.eyebrow {
		font-size: 0.75rem;
		text-transform: uppercase;
		letter-spacing: 0.3em;
		color: #38bdf8;
		margin-bottom: 0.4rem;
	}

	h1 {
		margin: 0 0 0.5rem;
		font-size: clamp(2rem, 4vw, 3.25rem);
	}

	h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.description {
		max-width: 60ch;
		color: #cbd5f5;
		margin: 0;
		line-height: 1.6;
	}

	.controls {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 16px;
		background: rgba(15, 23, 42, 0.72);
		padding: 20px;
		border-radius: 20px;
		border: 1px solid rgba(148, 163, 184, 0.15);
		backdrop-filter: blur(8px);
	}

	.control {
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.control__label {
		display: flex;
		justify-content: space-between;
		font-size: 0.95rem;
		color: #e2e8f0;
	}

	input[type='range'] {
		accent-color: #38bdf8;
		cursor: pointer;
	}

	.chart-card {
		background: rgba(2, 6, 23, 0.85);
		border-radius: 24px;
		padding: 24px;
		border: 1px solid rgba(56, 189, 248, 0.25);
		box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.7);
	}

	.chart-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 16px;
		gap: 16px;
	}

	.principal {
		color: #94a3b8;
		margin: 0;
		font-size: 0.95rem;
	}

	canvas {
		width: 100% !important;
		height: auto !important;
	}

	@media (max-width: 600px) {
		.controls {
			padding: 16px;
		}

		.chart-card {
			padding: 18px;
		}

		.chart-header {
			flex-direction: column;
			align-items: flex-start;
		}
	}
</style>
